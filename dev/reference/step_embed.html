<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Encoding Factors into Multiple Columns — step_embed • embed</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Encoding Factors into Multiple Columns — step_embed"><meta name="description" content="step_embed() creates a specification of a recipe step that will convert a
nominal (i.e. factor) predictor into a set of scores derived from a
tensorflow model via a word-embedding model. embed_control is a simple
wrapper for setting default options."><meta property="og:description" content="step_embed() creates a specification of a recipe step that will convert a
nominal (i.e. factor) predictor into a set of scores derived from a
tensorflow model via a word-embedding model. embed_control is a simple
wrapper for setting default options."><meta property="og:image" content="https://embed.tidymodels.org/logo.png"><meta name="robots" content="noindex"><script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="embed.tidymodels.org,all.tidymodels.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">embed</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.2.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Applications/GLM.html">Using Generalized Linear Models</a></li>
    <li><a class="dropdown-item" href="../articles/Applications/Tensorflow.html">Entity Embeddings of Categorical Variables using TensorFlow</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidymodels/embed/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Encoding Factors into Multiple Columns</h1>
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/embed/blob/main/R/embed.R" class="external-link"><code>R/embed.R</code></a></small>
      <div class="d-none name"><code>step_embed.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>step_embed()</code> creates a <em>specification</em> of a recipe step that will convert a
nominal (i.e. factor) predictor into a set of scores derived from a
tensorflow model via a word-embedding model. <code>embed_control</code> is a simple
wrapper for setting default options.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">step_embed</span><span class="op">(</span></span>
<span>  <span class="va">recipe</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  role <span class="op">=</span> <span class="st">"predictor"</span>,</span>
<span>  trained <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  outcome <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  predictors <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  num_terms <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  hidden_units <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  options <span class="op">=</span> <span class="fu">embed_control</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  mapping <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  history <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  keep_original_cols <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  skip <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/rand_id.html" class="external-link">rand_id</a></span><span class="op">(</span><span class="st">"embed"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">embed_control</span><span class="op">(</span></span>
<span>  loss <span class="op">=</span> <span class="st">"mse"</span>,</span>
<span>  metrics <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="st">"sgd"</span>,</span>
<span>  epochs <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  validation_split <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">32</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-recipe">recipe<a class="anchor" aria-label="anchor" href="#arg-recipe"></a></dt>
<dd><p>A recipe object. The step will be added to the sequence of
operations for this recipe.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>One or more selector functions to choose variables. For
<code>step_embed</code>, this indicates the variables to be encoded into a numeric
format. See <code><a href="https://recipes.tidymodels.org/reference/selections.html" class="external-link">recipes::selections()</a></code> for more details. For the <code>tidy</code>
method, these are not currently used.</p></dd>


<dt id="arg-role">role<a class="anchor" aria-label="anchor" href="#arg-role"></a></dt>
<dd><p>For model terms created by this step, what analysis role should
they be assigned?. By default, the function assumes that the embedding
variables created will be used as predictors in a model.</p></dd>


<dt id="arg-trained">trained<a class="anchor" aria-label="anchor" href="#arg-trained"></a></dt>
<dd><p>A logical to indicate if the quantities for preprocessing have
been estimated.</p></dd>


<dt id="arg-outcome">outcome<a class="anchor" aria-label="anchor" href="#arg-outcome"></a></dt>
<dd><p>A call to <code>vars</code> to specify which variable is used as the
outcome in the neural network.</p></dd>


<dt id="arg-predictors">predictors<a class="anchor" aria-label="anchor" href="#arg-predictors"></a></dt>
<dd><p>An optional call to <code>vars</code> to specify any variables to be
added as additional predictors in the neural network. These variables
should be numeric and perhaps centered and scaled.</p></dd>


<dt id="arg-num-terms">num_terms<a class="anchor" aria-label="anchor" href="#arg-num-terms"></a></dt>
<dd><p>An integer for the number of resulting variables.</p></dd>


<dt id="arg-hidden-units">hidden_units<a class="anchor" aria-label="anchor" href="#arg-hidden-units"></a></dt>
<dd><p>An integer for the number of hidden units in a dense ReLu
layer between the embedding and output later. Use a value of zero for no
intermediate layer (see Details below).</p></dd>


<dt id="arg-options">options<a class="anchor" aria-label="anchor" href="#arg-options"></a></dt>
<dd><p>A list of options for the model fitting process.</p></dd>


<dt id="arg-mapping">mapping<a class="anchor" aria-label="anchor" href="#arg-mapping"></a></dt>
<dd><p>A list of tibble results that define the encoding. This is
<code>NULL</code> until the step is trained by <code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">recipes::prep()</a></code>.</p></dd>


<dt id="arg-history">history<a class="anchor" aria-label="anchor" href="#arg-history"></a></dt>
<dd><p>A tibble with the convergence statistics for each term. This
is <code>NULL</code> until the step is trained by <code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">recipes::prep()</a></code>.</p></dd>


<dt id="arg-keep-original-cols">keep_original_cols<a class="anchor" aria-label="anchor" href="#arg-keep-original-cols"></a></dt>
<dd><p>A logical to keep the original variables in the
output. Defaults to <code>FALSE</code>.</p></dd>


<dt id="arg-skip">skip<a class="anchor" aria-label="anchor" href="#arg-skip"></a></dt>
<dd><p>A logical. Should the step be skipped when the recipe is baked by
<code><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">recipes::bake()</a></code>? While all operations are baked when <code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">recipes::prep()</a></code> is
run, some operations may not be able to be conducted on new data (e.g.
processing the outcome variable(s)). Care should be taken when using <code>skip = TRUE</code> as it may affect the computations for subsequent operations.</p></dd>


<dt id="arg-id">id<a class="anchor" aria-label="anchor" href="#arg-id"></a></dt>
<dd><p>A character string that is unique to this step to identify it.</p></dd>


<dt id="arg-optimizer-loss-metrics">optimizer, loss, metrics<a class="anchor" aria-label="anchor" href="#arg-optimizer-loss-metrics"></a></dt>
<dd><p>Arguments to pass to keras3::compile()</p></dd>


<dt id="arg-epochs-validation-split-batch-size-verbose-callbacks">epochs, validation_split, batch_size, verbose, callbacks<a class="anchor" aria-label="anchor" href="#arg-epochs-validation-split-batch-size-verbose-callbacks"></a></dt>
<dd><p>Arguments to pass
to keras3::fit()</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An updated version of <code>recipe</code> with the new step added to the
sequence of existing steps (if any). For the <code>tidy</code> method, a tibble with
columns <code>terms</code> (the selectors or variables for encoding), <code>level</code> (the
factor levels), and several columns containing <code>embed</code> in the name.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Factor levels are initially assigned at random to the new variables and these
variables are used in a neural network to optimize both the allocation of
levels to new columns as well as estimating a model to predict the outcome.
See Section 6.1.2 of Francois and Allaire (2018) for more details.</p>
<p>The new variables are mapped to the specific levels seen at the time of model
training and an extra instance of the variables are used for new levels of
the factor.</p>
<p>One model is created for each call to <code>step_embed</code>. All terms given to the
step are estimated and encoded in the same model which would also contain
predictors give in <code>predictors</code> (if any).</p>
<p>When the outcome is numeric, a linear activation function is used in the last
layer while softmax is used for factor outcomes (with any number of levels).</p>
<p>For example, the <code>keras3</code> code for a numeric outcome, one categorical
predictor, and no hidden units used here would be</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>  <span class="fu">keras_model_sequential</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">layer_embedding</span>(</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="at">input_dim =</span> num_factor_levels_x <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    <span class="at">output_dim =</span> num_terms</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="fu">layer_flatten</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> <span class="dv">1</span>, <span class="at">activation =</span> <span class="st">'linear'</span>)</span></code></pre><p></p></div>
<p>If a factor outcome is used and hidden units were requested, the code would
be</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>  <span class="fu">keras_model_sequential</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">layer_embedding</span>(</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    <span class="at">input_dim =</span> num_factor_levels_x <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    <span class="at">output_dim =</span> num_terms</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="fu">layer_flatten</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> hidden_units, <span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="at">units =</span> num_factor_levels_y, <span class="at">activation =</span> <span class="st">'softmax'</span>)</span></code></pre><p></p></div>
<p>Other variables specified by <code>predictors</code> are added as an additional dense
layer after <code>layer_flatten</code> and before the hidden layer.</p>
<p>Also note that it may be difficult to obtain reproducible results using this
step due to the nature of Tensorflow (see link in References).</p>
<p>tensorflow models cannot be run in parallel within the same session (via
<code>foreach</code> or <code>futures</code>) or the <code>parallel</code> package. If using a recipes with
this step with <code>caret</code>, avoid parallel processing.</p>
    </div>
    <div class="section level2">
    <h2 id="tidying">Tidying<a class="anchor" aria-label="anchor" href="#tidying"></a></h2>
    <p>When you <code><a href="https://recipes.tidymodels.org/reference/tidy.recipe.html" class="external-link">tidy()</a></code> this step, a tibble is returned with
a number of columns with embedding information, and columns <code>terms</code>,
<code>levels</code>, and <code>id</code>:</p>
<dl><dt>terms</dt>
<dd><p>character, the selectors or variables selected</p></dd>

<dt>levels</dt>
<dd><p>character, levels in variable</p></dd>

<dt>id</dt>
<dd><p>character, id of this step</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="tuning-parameters">Tuning Parameters<a class="anchor" aria-label="anchor" href="#tuning-parameters"></a></h2>
    <p>This step has 2 tuning parameters:</p><ul><li><p><code>num_terms</code>: # Model Terms (type: integer, default: 2)</p></li>
<li><p><code>hidden_units</code>: # Hidden Units (type: integer, default: 0)</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="case-weights">Case weights<a class="anchor" aria-label="anchor" href="#case-weights"></a></h2>



<p>The underlying operation does not allow for case weights.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Francois C and Allaire JJ (2018) <em>Deep Learning with R</em>, Manning</p>
<p>"Concatenate Embeddings for Categorical Variables with keras3"
<a href="https://flovv.github.io/Embeddings_with_keras_part2/" class="external-link">https://flovv.github.io/Embeddings_with_keras_part2/</a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">grants</span>, package <span class="op">=</span> <span class="st">"modeldata"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">grants_other</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="va">grants_other</span>, <span class="fl">500</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">num_ci</span> <span class="op">+</span> <span class="va">sponsor_code</span>, data <span class="op">=</span> <span class="va">grants_other</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">step_embed</span><span class="op">(</span><span class="va">sponsor_code</span>,</span></span>
<span class="r-in"><span>    outcome <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    options <span class="op">=</span> <span class="fu">embed_control</span><span class="op">(</span>epochs <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Emil Hvitfeldt, <a href="https://github.com/topepo" class="external-link">Max Kuhn</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer></body></html>

